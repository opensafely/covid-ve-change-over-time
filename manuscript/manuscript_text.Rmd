---
title: "Untitled"
author: "Elsie Horne"
date: "02/03/2022"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
```

## R Markdown

```{r}
library(tidyverse)
library(glue)
```

```{r paths}
# path for released results
release_folder <- "release_20220401"
```

```{r read-meta-data}
# read study parameters
study_parameters <- readr::read_rds(
  here::here("analysis", "lib", "study_parameters.rds"))

# read subgroups
subgroups <- readr::read_rds(
  here::here("analysis", "lib", "subgroups.rds"))
subgroup_labels <- seq_along(subgroups)
# subgroups_long <- if_else(
#     subgroups %in% subgroups[c(2,3)],
#     as.character(glue("{subgroups} and not clinically vulnerable")),
#     subgroups
#   )

# outcomes 
outcomes <- readr::read_rds(
  here::here("analysis", "lib", "outcomes.rds"))
outcomes_order <- c(which(outcomes == "covidadmitted"),
                    which(outcomes == "coviddeath"),
                    which(outcomes == "postest"),
                    which(outcomes == "noncoviddeath"),
                    which(outcomes == "anytest"))
select_outcomes <- unname(outcomes[outcomes_order])

```

```{r}
# read data
# read estimates data
estimates_all <- readr::read_csv(
  here::here(release_folder, "estimates_all.csv"))

# read metareg data
metareg_results_rhr <- readr::read_rds(
  here::here(release_folder, "metareg_results_rhr.rds")) %>%
  mutate(across(starts_with("rhr"), ~format(round(.x, 2), nmall=2))) %>%
  mutate(value = glue("{rhr} ({rhr_lower}-{rhr_higher})")) %>%
  mutate(across(subgroup, factor, levels = subgroups, labels = subgroups)) %>%
  arrange(outcome, subgroup, comparison) %>%
  select(outcome, subgroup, comparison, value)
```

```{r}
# scale for x-axis
K <- study_parameters$K
ends <- seq(2, (K+1)*4, 4)
starts <- ends + 1
weeks_since_2nd_vax <- str_c(starts[-(K+1)], ends[-1], sep = "-")

print_estimates <- function(sub, comp = c("BNT162b2", "ChAdOx1"), out) {
  estimates_all %>%
  filter(
    variable == "k", model == "adjusted",
    !reference_row,
    subgroup %in% sub,
    comparison %in% comp,
    outcome %in% out
    ) %>%
  mutate(across(subgroup, factor, levels = 1:4, labels = subgroups)) %>%
  mutate(across(label, factor, levels = as.character(1:6), labels = weeks_since_2nd_vax)) %>%
  arrange(subgroup, label, comparison) %>%
  mutate(across(c(estimate, conf.low, conf.high), ~format(round(exp(.x), 2), nsmall = 2))) %>%
  mutate(value = glue("{estimate} ({conf.low}-{conf.high})")) %>%
  select(subgroup, outcome, comparison, label, value)
}
```

# Abstract

Range of values for ratio of aHRs:

```{r}
metareg_results_rhr %>%
  filter(
    comparison != "both",
    outcome %in% c("covidadmitted", "coviddeath", "postest")
    ) %>%
  arrange(subgroup, comparison, value) %>%
  print(n=Inf)
```
Range of values for postest at 23-26 weeks:

```{r}
print_estimates(sub=1:4, out = "postest") %>%
  filter(label == "23-26") %>%
  arrange(comparison, label, value)
```

# Results
## Study population

TODO

## Attrition due to subsequent vaccination

TODO

## Waning vaccine effectiveness

Numbers of events:

```{r}
estimates_all %>%
  filter(variable == "k", comparison !="both", model == "adjusted") %>%
  mutate(group = if_else(label == "0", "unvax", comparison)) %>%
  distinct(subgroup, group, outcome, period, label, n_obs_label, n_event_label) %>%
  group_by(outcome, group) %>%
  summarise(total_events = sum(n_event_label, na.rm = TRUE), .groups = "keep") %>%
  ungroup() %>%
  mutate(across(total_events, ~scales::comma(.x, accuracy = 1))) %>%
  pivot_wider(
    names_from = group, values_from = total_events
  ) %>%
  mutate(phrase = glue("{BNT162b2}, {ChAdOx1} and {unvax}")) %>%
  select(outcome, phrase)
  # arrange(subgroup, outcome, group, period, label)
```

### COVID-19 hospitalisations / deaths

```{r}
for (i in 1:4) {
  print_estimates(sub=i, out = "coviddeath") %>% print()
}
```


### Positive SARS-CoV-2 tests / non-COVID-19 deaths

```{r}
print_estimates(sub=1:4, out = "postest") %>%
  arrange(comparison, label, value)
```
```{r}
print_estimates(sub=1:4, comp = "both", out = "postest") %>%
  arrange(comparison, label, value)
```

Range of values for covidadmitted and coviddeath

```{r}
print_estimates(sub=1:4, out = c("covidadmitted", "coviddeath")) %>%
  arrange(comparison, label, value)
```

Metareg results:

```{r}
metareg_results_rhr %>%
  filter(comparison != "both") %>%
  print(n=Inf)
```

# Discussion
## Findings in context

Comparison with Feikin et al.

```{r}
print_estimates(sub=1:4, out = c("covidadmitted", "coviddeath", "postest")) %>%
  filter(label %in% c("3-6", "23-26")) %>%
  mutate(value_num = 100*(1-as.numeric(str_extract(value, "^\\d{1}\\.\\d{2}")))) %>%
  select(subgroup, outcome, comparison, label, value_num) %>%
  pivot_wider(names_from = label, values_from = value_num) %>%
  mutate(across(`3-6`, ~if_else(is.na(.x), 100, .x))) %>%
  mutate(diff = `3-6` - `23-26`) %>%
  arrange(outcome, comparison, subgroup)
```



Comparison with Andrews et al.

```{r}
andrews <- tribble(
  ~comparison, ~subgroup, ~outcome, ~period, ~value,
  "ChAdOx1", "65+ years", "covidadmitted", "15-19", "85.8 (82.7–88.4)",
  "BNT162b2", "65+ years", "covidadmitted", "15-19", "93.4 (91.6–94.7)",
  "ChAdOx1", "40-64 years", "covidadmitted", "15-19", "94.4 (92.1–96.0)",
  "BNT162b2", "40-64 years", "covidadmitted", "15-19", "97.3 (94.2–98.7)",
  "ChAdOx1", "65+ years", "coviddeath", "15-19", "87.9 (82.6–91.5)",
  "BNT162b2", "65+ years", "coviddeath", "15-19", "93.2 (90.1–95.4)"
) %>%
  mutate(value_andrews = as.numeric(str_extract(value, "^\\d{2}\\.\\d{1}")))

print_estimates(sub=c(1,3), out = c("covidadmitted")) %>%
  filter(label %in% "15-18") %>%
  mutate(value_horne = 100*(1-as.numeric(str_extract(value, "^\\d{1}\\.\\d{2}")))) %>%
  select(subgroup, outcome, comparison, value_horne) %>%
  left_join(
    andrews %>% select(-period, -value), 
    by = c("subgroup", "outcome", "comparison")
  ) %>%
  mutate(diff = value_andrews - value_horne)

```

