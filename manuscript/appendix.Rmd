---
output: 
  bookdown::pdf_document2:
    includes:
      in_header: preamble.tex
      before_body: preface.tex
    keep_tex: true
    latex_engine: xelatex
    toc: false # defined in preface.tex
    number_sections: false
fontsize: 10
subparagraph: yes
geometry: margin=1.5cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  include = FALSE,
  fig.pos = "H"#,
  # ft.arraystretch=1
)
```

```{r libraries}
library(tidyverse)
library(kableExtra)
library(glue)
```

```{r paths}
# path for released results
release_folder <- here::here("release20220505")
```

```{r read-meta-data}
# read study parameters
study_parameters <- readr::read_rds(
  here::here("analysis", "lib", "study_parameters.rds"))

# read varlist
 model_varlist <- readr::read_rds(
    here::here("analysis", "lib", "model_varlist.rds"))

# read subgroups
subgroups <- readr::read_rds(
  here::here("analysis", "lib", "subgroups.rds"))
subgroup_labels <- seq_along(subgroups)
subgroups_long <- if_else(
    subgroups %in% subgroups[c(2,3)],
    as.character(glue("{subgroups} and not clinically vulnerable")),
    subgroups
  )

# outcomes 
outcomes <- readr::read_rds(
  here::here("analysis", "lib", "outcomes.rds"))
outcomes <- outcomes[outcomes != "covidemergency"]
outcomes_long <- names(outcomes)
outcomes_long[outcomes=="covidadmitted"] <- "COVID-19 hospitalisation"
names(outcomes) <- outcomes_long
rm(outcomes_long)
outcomes_order <- c(which(outcomes == "covidadmitted"),
                    which(outcomes == "coviddeath"),
                    which(outcomes == "postest"),
                    which(outcomes == "noncoviddeath"),
                    which(outcomes == "anytest"))
select_outcomes <- unname(outcomes[outcomes_order])

# scale for k
K <- study_parameters$K
ends <- seq(2, (K+1)*4, 4)
starts <- ends + 1
weeks_since_2nd_vax <- str_c(starts[-(K+1)], ends[-1], sep = "-")
```

```{r read-data}
# read event counts data
event_counts <- readr::read_csv(
  here::here(release_folder, "event_counts_all.csv")) %>%
  filter(outcome != "covidemergency") %>%
   mutate(
    sex = if_else(
      str_detect(subgroup, "Female|Male"),
      str_extract(subgroup, "Female|Male"),
      "Both"
      ),
    subgroup = as.integer(str_extract(subgroup, "\\d"))
    ) %>%
  mutate(across(arm,
                factor,
                levels = c("BNT162b2", "ChAdOx1", "unvax"),
                labels = c("BNT162b2", "ChAdOx1", "Unvaccinated"))) %>%
  mutate(across(outcome,
                factor,
                levels = unname(outcomes[outcomes_order]),
                labels = names(outcomes[outcomes_order])))


# read estimates data
estimates_all <- readr::read_csv(
  here::here(release_folder, "estimates_all.csv")) %>%
  filter(outcome != "covidemergency") %>%
   mutate(
    sex = if_else(
      str_detect(subgroup, "Female|Male"),
      str_extract(subgroup, "Female|Male"),
      "Both"
      ),
    subgroup = as.integer(str_extract(subgroup, "\\d"))
    ) %>%
  filter(
    !(comparison %in% c("BNT162b2", "both") & subgroup %in% c(3,4) & outcome == "noncoviddeath"),
    !(comparison %in% c("BNT162b2", "both") & subgroup %in% 3 & outcome == "covidadmitted")
    ) %>%
  mutate(across(c(estimate, conf.low, conf.high),
                ~round(exp(.x), 2), nsmall=2)) %>%
  mutate(across(outcome,
                factor,
                levels = unname(outcomes[outcomes_order]),
                labels = names(outcomes[outcomes_order]))) %>%
      mutate(across(comparison,
                  factor,
                  levels = c("BNT162b2", "ChAdOx1", "both"),
                  labels = c("BNT162b2 vs unvaccinated", "ChAdOx1 vs unvaccinated", "BNT162b2 vs ChAdOx1"))) 

# read metaregression results
metareg_results_k <- readr::read_rds(
  here::here(release_folder, "metareg_results_k.rds")) %>%
  mutate(across(subgroup, as.integer)) %>%
  mutate(across(outcome,
                factor,
                levels = unname(outcomes[outcomes_order]),
                labels = names(outcomes[outcomes_order]))) %>%
      mutate(across(comparison,
                  factor,
                  levels = c("BNT162b2", "ChAdOx1", "both"),
                  labels = c("BNT162b2 vs unvaccinated", "ChAdOx1 vs unvaccinated", "BNT162b2 vs ChAdOx1"))) %>%
   mutate(across(c(logrhr, logrhr_lower, logrhr_higher), 
                ~format(round(exp(.x), digits=2), nsmall=2, trim = TRUE))) %>%
  select(subgroup, sex, comparison, outcome, k, rhr = logrhr, rhr_lower = logrhr_lower, rhr_higher = logrhr_higher)
```

```{r kable-opts}
padding <- 0.5 # this is a guess, couldn't find default
page_height <- 26 #cm
page_width <- 16 #cm
```

```{r variable-defs}
variable_defs <- local({
  
  data <- tribble(
  ~type, ~name, ~description, ~encoding, ~date_defined,
  #
  "Exclusion criteria",
  "Evidence of prior COVID-19 infection",
  "Date of code corresponding to COVID-19 hospitalisation, positive SARS-CoV-2 test, or probable COVID-19 code in GP record.",
  "Date",
  "First occurence",
  #
  "Exclusion criteria",
  "End-of-life care pathway initiated",
  "Date of code corresponding to end-of-life care or midazolam injection used in end-of-life care in patient’s record.",
  "Date",
  "First occurence prior to SVP",
  #
  "Exclusion criteria",
  "Resident in care home",
  "Date of code corresponding to care home in patient’s record.",
  "Date",
  "First occurence prior to SVP",
  #
  "Exclusion criteria",
  "Medically housebound",
  "Date of most recent code corresponding to medically housebound patient’s record, not superceded by a code indicationg that the patient is no longer housebound.",
  "Date",
  "First occurence prior to SVP",
  #
  "Strata",
  "JCVI group",
  "Priority groups defined by the JCVI expert advisory group",
  "2-12",
  "Age defined on 31 March 2021 for individuals eligible in phase 1 and 1 July 2021 for individuals eligible in phase 2. Individuals defined as high risk on 18 Januray 2021, and at-risk on 15 February 2021. Priority groups 2-9 are as defined by the JCVI expert advisory group, and we further define groups 10, 11 and 12 are defined as those aged 40-49, 30-39 and 18-29 years, respectively, who were not assigned to JCVI groups 4 (high risk) or 6 (at-risk).",
  #
  "Strata",
  "Eligibility date",
  "Date on which JCVI group (or age range within group) became eligible for 1st dose of COVID-19 vaccination.",
  "Date",
  "-",
  #
  "Strata",
  "Region",
  "NHS region based on practice address.",
  "East of England; Midlands; London; North East; Yorkshire; North West; South East; South West.",
  "Eligibility date + 6 weeks.",
  #
  "Potential confounders (demographic)",
  "Sex",
  "-",
  "M; F.",
  "-",
  #
  "Potential confounders (demographic)",
  "Age",
  "Age in whole years.",
  "Numeric\\textsuperscript{a}",
  "Start of SVP",
  #
  "Potential confounders (demographic)",
  "Ethnicity",
  "From primary care records or SUS if missing from primary care.",
  "Black; Mixed; South Asian; White; Other.",
  "Eligibility date + 6 weeks ",
  #
  "Potential confounders (demographic)",
  "Index of Multiple Deprivation (IMD)",
  "IMD quintile based on patient address. The IMD is a measure of socioeconomic deprivation based on lower-layer super output area (LSOA; a small geographical area defined by the Office of National Statistics).",
  "1; 2; 3; 4; 5.",
  "Eligibility date + 6 weeks ",
  #
  "Potential confounders (clinical)",
  "Body Mass Index (BMI)",
  "Based on numeric BMI data from primary care records.",
  "Under 30kg/m\\textsuperscript{2} or not recorded; 30-34.9; 35-39.9; 40+ kg/m\\textsuperscript{2}.",
  "Start of SVP",
  #
  "Potential confounders (clinical)",
  "Learning disability including Down’s syndrome.",
  "Any code in primary care record before date defined.",
  "0; 1.",
  "Start of SVP",
  #
  "Potential confounders (clinical)",
  "Serious mental illness.",
  "Any code in primary care record before date defined.",
  "0; 1.",
  "Start of SVP",
  #
  "Potential confounders (clinical)",
  "Multimorbidity",
  "Number of the following comorbid conditions in different organ systems: Chronic heart disease; Chronic respiratory disease; Chronic liver disease; Chronic kidney disease; Diabetes; Chronic neurological disease; Immunosuppressed (diagnosis of permenant immunosuppression or asplenia, or currently taking immunosuppresant medication)",
  "0; 1; 2+",
  "Start of SVP",
  #
  "Potential confounders (clinical)",
  "Influenza vaccination",
  "Any record in past 5 years.",
  "0; 1.",
  "Start of SVP",
  #
  "Potential confounders (clinical)",
  "Pregnancy",
  "Pregnancy recorded in 36 weeks prior to date and no delivery code recorded more recently that pregnancy code.",
  "0; 1.",
  "Start of SVP",
  #
  "Potential confounders (clinical)",
  "Number of SARS-CoV-2 tests.",
  "SARS-CoV-2 tests were identified using SGSS records and based on swab date. Both polymerase chain reaction (PCR) and lateral flow tests will be included, without differentiation between symptomatic and asymptomatic infection.",
  "Integer",
  "Between 18 May 2020 (when widespread testing became available in England) and the earliest date of eligibility for first dose in the subgroup."
  )
  
  col_width <- (page_height - ncol(data)*padding)/ncol(data)
  col_width <- as.character(glue("{col_width}cm"))
  
  data %>%
   kable(
      format = "latex",
      caption = "Variable definitions",
      col.names = c("Group", "Name", "Description", "Encoding", "Date defined"),
      booktabs = TRUE, 
      longtable = TRUE,
      escape = FALSE # manually escape all special characters
    ) %>%
    row_spec(0, bold=TRUE) %>%
    column_spec(seq_along(data), width=col_width) %>%
    collapse_rows(
      columns = 1, 
      valign = "top",
      latex_hline = "major"
      ) %>%
    kable_styling(
      font_size = 8,
      latex_options = c("hold_position", "repeat_header")
      ) %>%
    footnote(
      general = c("JCVI: Joint Committee on Vaccination and Immunisation; SVP: second vaccination period.\\\\newline"),
      general_title = "",
      alphabet = "Age was modelled separately within each strata. Age within strata was modelled as linear, with quadratic terms additionally included for strata with age range >5 years.",
      footnote_as_chunk=TRUE,
      escape=FALSE,
      threeparttable = TRUE # to wrap footnote
    )
  
})
```


```{r prep-table1}
print_table1 <- local({
  
  table1_supplement <- readr::read_rds(
  here::here(release_folder, "table1_supplement.rds"))
  
  col_names <- table1_supplement$col_names
  cols_subtype <- table1_supplement$cols_subtype
  table1_data <- table1_supplement$data
  
  col_width <- (26 - ncol(table1_data)*padding)/ncol(table1_data)
  col_width <- as.character(glue("{col_width}cm"))


  table1 <- table1_data %>%
    kable(
      format = "latex",
      col.names = col_names,
      caption = "Additional characteristics summarised across subgroups.",
      booktabs = TRUE, 
      longtable = TRUE
    ) %>%
    row_spec(0, bold=TRUE) %>%
    add_header_above(
      c(" " = 2, cols_subtype),
      bold=TRUE,
      escape = FALSE
      ) %>%
    column_spec(seq_along(table1_data), width=col_width) %>%
    collapse_rows(columns = 1, valign = "top", latex_hline = "major") %>%
    kable_styling(
      font_size = 6,
      latex_options = c("hold_position", "repeat_header")
      ) %>%
    footnote(
      alphabet = c("And not clinically vulnerable"),
      footnote_as_chunk=TRUE,
      escape=FALSE
    )
  
  return(table1)
  
})
```

```{r prep-table-events}
table_events_ft <- function(s) {
  
  caption_string <- "Event counts / person-years"
  if (s == "Both") {
    caption_string <- glue("{caption_string}.")
  } else {
    caption_string <- glue("{caption_string} ({str_to_lower(s)} only model).")
  }
  
  data <- event_counts %>%
    filter(sex == s) %>%
    select(-sex)
  
  totals <- data %>%
    group_by(subgroup, arm, outcome) %>%
    summarise(across(c(person_years, events), sum, na.rm=TRUE), .groups="keep") %>%
    ungroup() %>%
    mutate(k=7)
  
  table_out0 <- data %>%
    bind_rows(totals) %>%
    arrange(subgroup, outcome, arm, k) %>%
    mutate(across(c(events, person_years), ~scales::comma(.x, accuracy = 1))) %>%
    mutate(across(events, ~if_else(.x == "0", "-", .x))) %>%
    mutate(name = as.character(glue("{subgroup}_{arm}"))) %>%
    mutate(value = as.character(glue("{events} / {person_years}"))) %>%
    mutate(across(value, ~str_replace(.x, "NA", "-"))) %>%
    select(name, value, k, outcome) %>%
    pivot_wider(
      names_from =  name,
      values_from = value
    ) %>%
    mutate(across(k,
                  factor,
                  levels = 1:7,
                  labels = c(weeks_since_2nd_vax, "Total"))) %>%
    select(outcome, k, starts_with(as.character(1:4)))
  
  # column names for table
  table_names <- names(table_out0)
  col_names <- str_remove(table_names, "\\d_")
  names(col_names) <- table_names
  cols_subtype <- sapply(
    as.character(subgroup_labels), 
    function(x) sum(str_detect(table_names, glue("{x}_")))
  )
  names(cols_subtype) <- subgroups
  col_names["k"] <- "Weeks since 2nd dose"
  col_names["outcome"] <- "Outcome"
  
  cols_subtype <- cols_subtype
  # add footnote marker to not clinically vulnerable subgroups
  names(cols_subtype)[3:4] <- str_c(
    names(cols_subtype)[3:4],
    footnote_marker_alphabet(1, format = "latex", double_escape = TRUE)
    )
  
  
  col_1_width <- 1
  col_2_width <- 0.8
  col_width <- (26 - col_1_width - col_2_width - ncol(table_out0)*padding)/(ncol(table_out0) - 2)
  col_1_width <- as.character(glue("{col_1_width}cm"))
  col_2_width <- as.character(glue("{col_2_width}cm"))
  col_width <- as.character(glue("{col_width}cm"))
  
  table_out1 <- table_out0 %>%
    kable(
      format = "latex",
      col.names = col_names,
      caption = caption_string, 
      booktabs = TRUE, 
      longtable = TRUE
    ) %>%
    row_spec(0, bold=TRUE) %>%
    add_header_above(
      c(" " = 2, cols_subtype),
      bold=TRUE,
      escape = FALSE
      ) %>%
    column_spec(1, width=col_1_width) %>%
    column_spec(2, width=col_2_width) %>%
    column_spec(3:ncol(table_out0), width=col_width) %>%
    collapse_rows(columns = 1, valign = "top", latex_hline = "major") %>%
    kable_styling(
      font_size = 6,
      latex_options = c("hold_position", "repeat_header")
      ) %>%
    footnote(
      alphabet = c("And not clinically vulnerable"),
      footnote_as_chunk=TRUE,
      escape=FALSE
    )
  
  return(table_out1)
  
}
```

```{r prep-table-hrs}
table_hrs_ft <- function(m, s){
  
  if (m == "unadjusted") {
    caption_string <- "Unadjusted hazard ratios for effect of vaccination"
  } else if (m == "adjusted") {
    caption_string <- "Adjusted hazard ratios for effect of vaccination"
  }
  
  if (s == "Both") {
    caption_string <- glue("{caption_string}.")
  } else {
    caption_string <- glue("{caption_string} ({str_to_lower(s)} only model).")
  }
  
  table_out0 <- estimates_all %>%
    filter(
      variable == "k",
      model == m,
      sex == s,
      !reference_row
      ) %>%
    mutate(across(c(estimate, conf.low, conf.high), ~format(.x, nsmall=2))) %>%
    mutate(
      name = glue("{subgroup}_{comparison}"),
      value = glue("{estimate} ({conf.low}-{conf.high})")
    ) %>%
    mutate(across(c(name, value), as.character)) %>%
    mutate(k = factor(as.integer(label),
                      levels = 1:K,
                      labels = weeks_since_2nd_vax)) %>%
    arrange(subgroup, comparison, outcome, k) %>%
    select(name, outcome, k, value) %>%
    pivot_wider(
      names_from = name,
      values_from = value
    ) %>%
    select(outcome, k, starts_with(as.character(1:4))) %>%
     mutate(across(starts_with(as.character(1:4)),
                  ~ if_else(
                    str_detect(.x, "NA"),
                    NA_character_,
                    .x)
                  )) 
  
  drop_cols <- sapply(
    seq_along(table_out0),
    function(x) all(is.na(table_out0[[x]]))
  )
  
  # column names for table
  table_names <- names(table_out0)
  col_names <- str_remove(table_names, "\\d_")
  names(col_names) <- table_names
  cols_subtype <- sapply(
    as.character(subgroup_labels), 
    function(x) sum(str_detect(table_names, glue("{x}_")))
  )
  
  names(cols_subtype) <- subgroups
  col_names["k"] <- "Weeks since 2nd dose"
  col_names["outcome"] <- "Outcome"
  
  cols_subtype <- cols_subtype
  # add footnote marker to not clinically vulnerable subgroups
  names(cols_subtype)[3:4] <- str_c(
    names(cols_subtype)[3:4],
    footnote_marker_alphabet(1, format = "latex", double_escape = TRUE)
    )
  
  col_width <- (26 - ncol(table_out0)*padding)/ncol(table_out0)
  col_width <- as.character(glue("{col_width}cm"))
  
  table_out1 <- table_out0 %>%
    select(all_of(table_names)) %>%
    mutate(across(starts_with(as.character(subgroup_labels)),
                  ~ if_else(
                    is.na(.x),
                    "-",
                    .x)
                  ))  %>%
    kable(
      format = "latex",
      col.names = col_names,
      caption = caption_string,
      booktabs = TRUE, 
      longtable = TRUE
    ) %>%
    row_spec(0, bold=TRUE) %>%
    add_header_above(
      c(" " = 2, cols_subtype),
      bold=TRUE,
      escape = FALSE
      ) %>%
    column_spec(seq_along(table_out0), width=col_width) %>%
    collapse_rows(columns = 1, valign = "top", latex_hline = "major") %>%
    kable_styling(
      font_size = 6,
      latex_options = c("hold_position", "repeat_header")
      ) %>%
    footnote(
      alphabet = c("And not clinically vulnerable"),
      footnote_as_chunk=TRUE,
      escape=FALSE
    )
  
  return(table_out1)
  
}
```

```{r prep-table-metareg}
table_metareg_ft <- function(s) {
    
  caption_string <- "Per-comparison-period ratio of adjusted hazard ratios for effect of vaccination"
  if (s == "Both") {
    caption_string <- glue("{caption_string}.")
  } else {
    caption_string <- glue("{caption_string} ({str_to_lower(s)} only model).")
  }
  
  table_out0 <- metareg_results_k %>%
    filter(sex == s) %>%
  mutate(
      name = glue("{subgroup}_{comparison}"),
      value = glue("{rhr} ({rhr_lower}-{rhr_higher})")
    ) %>%
    mutate(across(c(name, value), as.character)) %>%
    arrange(subgroup, sex, comparison, outcome) %>%
    distinct(name, outcome, value) %>%
    pivot_wider(
      names_from = name,
      values_from = value
    ) %>%
    select(outcome, starts_with(as.character(subgroup_labels))) %>%
    mutate(across(starts_with(as.character(subgroup_labels)),
                  ~ if_else(
                    str_detect(.x, "NA"),
                    NA_character_,
                    .x)
                  )) 
  
  drop_cols <- sapply(
    seq_along(table_out0),
    function(x) all(is.na(table_out0[[x]]))
  )
  
  # column names for table
  table_names <- names(table_out0)
  col_names <- str_remove(table_names, "\\d_")
  names(col_names) <- table_names
  cols_subtype <- sapply(
    as.character(subgroup_labels), 
    function(x) sum(str_detect(table_names, glue("{x}_")))
  )
  
  names(cols_subtype) <- subgroups
  col_names["outcome"] <- "Outcome"
  
  cols_subtype <- cols_subtype[subgroup_labels]
  # add footnote marker to not clinically vulnerable subgroups
  names(cols_subtype)[3:4] <- str_c(
    names(cols_subtype)[3:4],
    footnote_marker_alphabet(1, format = "latex", double_escape = TRUE)
    )
  
  col_width <- (26 - ncol(table_out0)*padding)/ncol(table_out0)
  col_width <- as.character(glue("{col_width}cm"))
  
  table_out1 <- table_out0 %>%
    select(all_of(table_names)) %>%
    mutate(across(starts_with(as.character(subgroup_labels)),
                  ~ if_else(
                    is.na(.x),
                    "-",
                    .x)
                  ))  %>%
    kable(
      format = "latex",
      col.names = col_names,
      caption = caption_string,
      booktabs = TRUE, 
      longtable = TRUE
    ) %>%
    row_spec(0, bold=TRUE) %>%
    add_header_above(
      c(" " = 1, cols_subtype),
      bold=TRUE,
      escape = FALSE
      ) %>%
    column_spec(seq_along(table_out0), width=col_width) %>%
    collapse_rows(columns = 1, valign = "top", latex_hline = "major") %>%
    kable_styling(
      font_size = 6,
      latex_options = c("hold_position", "repeat_header")
      ) %>%
    footnote(
      alphabet = c("And not clinically vulnerable"),
      footnote_as_chunk=TRUE,
      escape=FALSE
    )
  
  return(table_out1)
  
}
```

```{r prep-table-estimates-covs}

variable_order <- c(model_varlist$demographic, model_varlist$clinical)
  names(variable_order)[variable_order == "test_hist_n"] <- "Number of SARS-CoV-2 tests"
  names(variable_order)[variable_order == "flu_vaccine"] <- "Flu vaccine"
  
names_key <- tibble(
  names_long = names(variable_order),
  variable = variable_order
)

tables_data <- names_key %>%
  left_join(estimates_all %>%
              mutate(across(variable, ~if_else(str_detect(.x, "^age"), "age", .x))), 
            by = "variable") %>%
  filter(variable != "k", model == "adjusted") %>%
  mutate(across(c(estimate, conf.low, conf.high), format, trim = TRUE, nsmall = 2, scientific = FALSE)) %>%
  mutate(value = glue("{estimate} ({conf.low}-{conf.high})")) %>%
  mutate(across(value, ~str_remove(.x, "\\(NA-NA\\)"))) %>%
  mutate(across(label, ~str_remove(.x, "^age_"))) %>%
  mutate(across(label, ~str_replace(.x, "plus", "+"))) %>%
  mutate(across(label, ~str_replace(.x, "to", "-"))) %>%
  mutate(across(label, ~str_replace(.x, "_", " "))) %>%
  mutate(across(label, ~str_remove(.x, "\\s\\w+\\sdeprived"))) %>%
  mutate(across(label, ~str_remove_all(.x, "Obese\\s\\w+\\s"))) %>%
  mutate(across(label, ~str_replace(.x, "Not obese", "<30 or missing"))) %>%
  mutate(across(label,
                ~if_else(
                  variable == "bmi",
                  str_remove_all(.x, "\\(|\\)"),
                  .x
                  ))) %>%
  mutate(across(label,
                ~if_else(
                  str_detect(.x, "TRUE"),
                  "",
                  .x
                ))) %>%
  select(comparison, subgroup, sex, outcome, period, variable = names_long, label, value) %>%
  mutate(across(variable, ~if_else(.x == "Age", "Age*", .x))) %>%
  pivot_wider(names_from = period, values_from = value) %>%
  mutate(across(starts_with(as.character(1:6)), ~if_else(is.na(.x), "-", .x)))  

table_coef_hrs <- function(comp, sub, s, o){
  
  data <- tables_data %>%
    filter(
      comparison == comp,
      subgroup == sub,
      sex == s,
      outcome == names(outcomes)[outcomes == o]
    ) %>%
    select(-comparison, -subgroup, -sex, -outcome)
  
  age_order <- data %>% 
  filter(variable == "Age") %>%
  distinct(variable, label) %>%
  arrange(label)
  
  table_out0 <- age_order %>%
    full_join(data, by = c("variable", "label"))
  
  caption_string <- glue("Covariate hazard ratios for each outcome and comparison period in the {subgroups[sub]} subgroup")

  if (s == "Both") {
    caption_string <- glue("{caption_string}.")
  } else {
    caption_string <- glue("{caption_string} ({str_to_lower(s)} only model).")
  }
  
  caption_string <- glue("{caption_string} [*Provide some explanation for age categories.]")
  
  # column names for table
  table_names <- names(table_out0)
  col_names <- str_to_title(table_names)
  col_names[col_names == "Label"] <- "Category"
  names(col_names) <- table_names
  
  col_width <- (26 - ncol(table_out0)*padding)/ncol(table_out0)
  col_width <- as.character(glue("{col_width}cm"))
  
  table_out1 <- table_out0 %>%
    select(all_of(table_names)) %>%
    kable(
      format = "latex",
      col.names = col_names,
      caption = caption_string,
      booktabs = TRUE, 
      longtable = TRUE
    ) %>%
    row_spec(0, bold=TRUE) %>%
    add_header_above(
      c(" " = 2, "Comparison period" = 6),
      bold=TRUE,
      escape = FALSE
      ) %>%
    column_spec(seq_along(table_out0), width=col_width) %>%
    collapse_rows(columns = 1, valign = "top") %>%
    kable_styling(
      font_size = 6,
      latex_options = c("hold_position", "repeat_header")
      ) #%>%
    # footnote(
    #   alphabet = c("And not clinically vulnerable"),
    #   footnote_as_chunk=TRUE,
    #   escape=FALSE
    # )
  
  return(table_out1)
  
}

```


# Supplementary Methods

```{r jcvi-groups, include=TRUE, tab.cap.pre = "Supplementary Table "}
tribble(
  ~phase, ~priority_group, ~description,
  "1", "1", "Residents in a care home for older adults",
  "1", "1", "Staff in a care home for older adults",
  "1", "2", "All those 80 years of age and over",
  "1", "2", "Frontline health and social care workers",
  "1", "3", "All those 75 years of age and over",
  "1", "4a", "All those 70 years of age and over",
  "1", "4b", "Individuals aged 16 to 69 in a high risk group\\textsuperscript{a}",
  "1", "5", "All those 65 years of age and over",
  "1", "6", "Individuals aged 16 to 65 years in an at-risk group\\textsuperscript{a}",
  "1", "7", "All those 60 years of age and over",
  "1", "8", "All those 55 years of age and over",
  "1", "9", "All those 50 years of age and over",
  "2", "10", "All those 40 years of age and over",
  "2", "11", "All those 30 years of age and over",
  "2", "12", "All those 18 years of age and over"
) %>%
  kable(
      format = "latex",
      caption = "Vaccination phases and priority groups for primary vaccination advised by the Joint Committee on Vaccination and Immunisation",
      col.names = c("Vaccination phase", "Priority group", "Risk group"),
      booktabs = TRUE, 
      longtable = TRUE,
      escape = FALSE # manually escape all special characters
    ) %>%
    row_spec(0, bold=TRUE) %>%
    column_spec(1, width="1.5cm") %>%
  column_spec(2, width="1.5cm") %>%
    column_spec(3, width="9cm") %>%
    collapse_rows(
      columns = 1:2, 
      valign = "top",
      latex_hline = "major"
      ) %>%
    kable_styling(
      font_size = 8,
      latex_options = c("hold_position", "repeat_header")
      ) %>%
  footnote(
    alphabet = c("See \\\\href{https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/1057798/Greenbook-chapter-14a-28Feb22.pdf}{COVID-19: the green book, chapter 14a} for definitions of the high-risk and at-risk groups."),
    escape = FALSE
  )

```

\pagebreak

```{r eligibility-dates, include=TRUE, tab.cap.pre = "Supplementary Table "}

elig_dates <-
tribble(
    ~grouped_date, ~date, ~age_range, ~jcvi_groups, ~source,
    "2020-12-08", "2020-12-08", "-", "1, 2", "-",
    "2021-01-18", "2021-01-18", "-", "3, 4a, 4b", "https://www.bbc.co.uk/news/uk-55698132",
    ###
    "2021-02-15", "2021-02-15", "-", "5, 6", "https://www.england.nhs.uk/statistics/wp-content/uploads/sites/2/2021/02/COVID-19-weekly-announced-vaccinations-25-February-2021.pdf",
    ###
    "2021-02-22", "2021-02-22", "64", "7", "https://www.england.nhs.uk/2021/03/nhs-invites-people-aged-60-plus-to-book-life-saving-covid-jab/", 
    "2021-03-01", "2021-03-01", "60-63", "7", "https://www.england.nhs.uk/2021/03/nhs-invites-people-aged-60-plus-to-book-life-saving-covid-jab/",
    ###
    # combine 2 rows as < 7 days between elig_dates
    "2021-03-08", "2021-03-08", "56-59", "8", "https://www.england.nhs.uk/2021/03/56-59/",
    "2021-03-08", "2021-03-09", "55", "8", "https://web.archive.org/web/20210309005613/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    ###
    "2021-03-19", "2021-03-19", "50-54", "9", "https://web.archive.org/web/20210319164659/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    ###
    "2021-04-13", "2021-04-13", "45-49", "10", "https://web.archive.org/web/20210413144439/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    # combine 3 rows as < 7 days between elig_dates
    "2021-04-26", "2021-04-26", "44", "10", "https://web.archive.org/web/20210426123732/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    "2021-04-26", "2021-04-27", "42-43", "10", "https://web.archive.org/web/20210427083317/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    "2021-04-26", "2021-04-30", "40-41", "10", "https://web.archive.org/web/20210430164542/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    ###
    # combine 2 rows as < 7 days between elig_dates
    "2021-05-13", "2021-05-13", "38-39", "11", "https://web.archive.org/web/20210513193310/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    "2021-05-13", "2021-05-19", "36-37", "11", "https://web.archive.org/web/20210519122344/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    # combine 3 rows as < 7 days between elig_dates
    "2021-05-21", "2021-05-21", "34-35", "11", "https://web.archive.org/web/20210521233727/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    "2021-05-21", "2021-05-25", "32-33", "11", "https://web.archive.org/web/20210525112033/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    "2021-05-21", "2021-05-26", "30-31", "11", "https://web.archive.org/web/20210526111444/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    ###
    "2021-06-08", "2021-06-08",  "25-29", "12", "https://web.archive.org/web/20210526111444/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    # combine 3 rows as < 7 days between elig_dates
    "2021-06-15", "2021-06-15", "23-24", "12", "https://web.archive.org/web/20210615132025/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    "2021-06-15", "2021-06-16", "21-22", "12", "https://web.archive.org/web/20210616074746/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/",
    "2021-06-15", "2021-06-18", "18-20", "12", "https://web.archive.org/web/20210618093608/https://www.nhs.uk/conditions/coronavirus-covid-19/coronavirus-vaccination/who-can-get-the-vaccine/"
) 

  
  col_width <- (page_width - ncol(elig_dates)*padding)/ncol(elig_dates)
  col_width <- as.character(glue("{col_width}cm"))

elig_dates %>%
  select(grouped_date, date, jcvi_groups, age_range, source) %>%
  mutate(across(source,
                ~str_c("\\href{", .x, "}{source}"))) %>%
  kable(
      format = "latex",
      caption = "Eligibility dates for first vaccine dose",
      col.names = c("Grouped eligibility date", "Exact eligibility date", "JCVI groups", "Age range", "Reference"),
      booktabs = TRUE, 
      longtable = TRUE,
      escape = FALSE # manually escape all special characters
    ) %>%
    row_spec(0, bold=TRUE) %>%
    column_spec(seq_along(elig_dates), width=col_width) %>%
    collapse_rows(
      columns = 1, 
      valign = "top",
      latex_hline = "major"
      ) %>%
    kable_styling(
      font_size = 8,
      latex_options = c("hold_position", "repeat_header")
      ) %>%
    footnote(
      general = c("JCVI: Joint Committee on Vaccination and Immunisation"),
      general_title = "",
      footnote_as_chunk=TRUE,
      escape=FALSE,
      threeparttable = TRUE # to wrap footnote
    )

```

```{r print-variable-defs, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(variable_defs)
```


```{r eligibilty-criteria, include=TRUE, fig.cap="Study eligibility criteria.", out.width="\\linewidth"}
knitr::include_graphics(here::here("manuscript", "images", "eligibility_criteria.png"))
```

# Supplementary Results
<!-- Test some text referring to \figref{fig:svp-10-2021-04-13} and \tabref{tab:table1}. -->
## Study population

```{r flow-diagram, include=TRUE, fig.cap="Flow of individuals into study", out.width="\\linewidth"}
knitr::include_graphics(here::here("manuscript", "images", "flow_results.png"))
```

\begin{landscape}

```{r svp-02-2020-12-08, include=TRUE, fig.cap="Second vaccination period for JCVI group 2", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_02_2020-12-08.png"))
```

```{r svp-03-2020-12-08, include=TRUE, fig.cap="Second vaccination period for JCVI group 3", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_03_2021-01-18.png"))
```

```{r svp-04a-2021-01-18, include=TRUE, fig.cap="Second vaccination period for JCVI group 4", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_04a_2021-01-18.png"))
```

```{r svp-04b-2021-01-18, include=TRUE, fig.cap="Second vaccination period for JCVI group 4", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_04b_2021-01-18.png"))
```

```{r svp-05-2021-02-15, include=TRUE, fig.cap="Second vaccination period for JCVI group 5", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_05_2021-02-15.png"))
```

```{r svp-06-2021-02-15, include=TRUE, fig.cap="Second vaccination period for JCVI group 6", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_06_2021-02-15.png"))
```

```{r svp-07-2021-02-22, include=TRUE, fig.cap="Second vaccination period for JCVI group 7 and aged 64 years", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_07_2021-02-22.png"))
```

```{r svp-07-2021-03-01, include=TRUE, fig.cap="Second vaccination period for JCVI group 7 and aged 60-63 years", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_07_2021-03-01.png"))
```

```{r svp-08-2021-03-08, include=TRUE, fig.cap="Second vaccination period for JCVI group 8", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_08_2021-03-08.png"))
```

```{r svp-09-2021-03-19, include=TRUE, fig.cap="Second vaccination period for JCVI group 9", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_09_2021-03-19.png"))
```

```{r svp-10-2021-04-13, include=TRUE, fig.cap="Second vaccination period for JCVI group 10 and aged 45-49 years", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_10_2021-04-13.png"))
```

```{r svp-10-2021-04-26, include=TRUE, fig.cap="Second vaccination period for JCVI group 10 and aged 40-44 years", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_10_2021-04-26.png"))
```

```{r svp-11-2021-05-13, include=TRUE, fig.cap="Second vaccination period for JCVI group 11 and aged 36-39 years", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_11_2021-05-13.png"))
```

```{r svp-11-2021-05-21, include=TRUE, fig.cap="Second vaccination period for JCVI group 11 and aged 30-35 years", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_11_2021-05-21.png"))
```

```{r svp-12-2021-06-08, include=TRUE, fig.cap="Second vaccination period for JCVI group 12 and aged 25-29 years", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_12_2021-06-08.png"))
```

```{r svp-12-2021-06-15, include=TRUE, fig.cap="Second vaccination period for JCVI group 12 and aged 18-24 years", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "svp_plots", "plot_by_region_12_2021-06-15.png"))
```

\end{landscape}

```{r table1, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(print_table1)
```

## Attrition due to subsequent vaccination

```{r ci-vax, include=TRUE, fig.cap="Cumulative incidence of subsequent vaccination. *And not clinically vulnerable.", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "ci_vax.png"))
```

## Distribution of follow-up time

```{r check-fu-65, include=TRUE, fig.cap="Distribution of follow-up time across the six comparison periods in the 65+ years subgroup. [add reference for dates]", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "variants", "check_fu_65+ years.png"))
```

```{r check-fu-18-64, include=TRUE, fig.cap="Distribution of follow-up time across the six comparison periods in the 18-64 years and clinically vulnerable subgroup. [add reference for dates]", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "variants", "check_fu_18-64 years and clinically vulnerable.png"))
```

```{r check-fu-40-64, include=TRUE, fig.cap="Distribution of follow-up time across the six comparison periods in the 40-64 years subgroup. [add reference for dates]", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "variants", "check_fu_40-64 years.png"))
```

```{r check-fu-18-39, include=TRUE, fig.cap="Distribution of follow-up time across the six comparison periods in the 18-39 years subgroup. [add reference for dates]", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "variants", "check_fu_18-39 years.png"))
```

## Waning vaccine effectiveness in risk-based subgroups
[Add some text to describe what is in section.]

```{r table-events, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_events_ft("Both"))
```

```{r table-hrs-ft, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_hrs_ft(m = "unadjusted", s = "Both"))
```

```{r table-ahrs-ft, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_hrs_ft(m = "adjusted", s = "Both"))
```

```{r table-ratio-hrs-ft, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_metareg_ft(s = "Both"))
```

\begin{landscape}

```{r hr-vax-BNT162b2, include=TRUE, fig.cap="Unadjusted and adjusted hazard ratios for BNT162b2 vs unvaccinated", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_BNT162b2_unadj.png"))
```

```{r hr-vax-ChAdOx, include=TRUE, fig.cap="Unadjusted and adjusted hazard ratios for ChAdOx1 vs unvaccinated", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_ChAdOx1_unadj.png"))
```

```{r hr-vax-both, include=TRUE, fig.cap="Unadjusted and adjusted hazard ratios for BNT162b2 vs ChAdOx1", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_both_unadj.png"))
```

\end{landscape}

```{r hr-vax-anytest-BNT162b2, include=TRUE, fig.cap="Unadjusted and adjusted hazard ratios for any SARS-CoV-2 test for BNT162b2 vs unvaccinated", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_anytest_BNT162b2_unadj.png"))
```

```{r hr-vax-anytest-ChAdOx, include=TRUE, fig.cap="Unadjusted and adjusted hazard ratios for any SARS-CoV-2 test for ChAdOx1 vs unvaccinated", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_anytest_ChAdOx1_unadj.png"))
```

```{r hr-vax-anytest-both, include=TRUE, fig.cap="Unadjusted and adjusted hazard ratios for any SARS-CoV-2 test for BNT162b2 vs ChAdOx1", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_anytest_both_unadj.png"))
```

```{r hr-vax-anytest, include=TRUE, fig.cap="Adjusted hazard ratios for any SARS-CoV-2 test for BNT162b2 and ChAdOx1 vs unvaccinated", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_anytest.png"))
```

```{r hr-brand-anytest, include=TRUE, fig.cap="Adjusted hazard ratios for any SARS-CoV-2 test for BNT162b2 vs ChAdOx1", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_brand_anytest.png"))
```

```{r coef-BN-1-B-postest, include=TRUE}
landscape(
  table_coef_hrs(
    comp = "BNT162b2 vs unvaccinated",
    sub = 1,
    s = "Both",
    o = "postest"
    ))
```

## Waning vaccine effectiveness in risk- and sex-based subgroups
[Add some text to describe what is in section.]

```{r table-events-female, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_events_ft("Female"))
```

```{r table-events-male, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_events_ft("Male"))
```

```{r table-hrs-ft-female, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_hrs_ft(m = "unadjusted", s = "Female"))
```

```{r table-hrs-ft-male, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_hrs_ft(m = "unadjusted", s = "Male"))
```

```{r table-ahrs-ft-female, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_hrs_ft(m = "adjusted", s = "Female"))
```

```{r table-ahrs-ft-male, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_hrs_ft(m = "adjusted", s = "Male"))
```

```{r table-ratio-hrs-ft-female, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_metareg_ft(s = "Female"))
```

```{r table-ratio-hrs-ft-male, include=TRUE, tab.cap.pre = "Supplementary Table "}
landscape(table_metareg_ft(s = "Male"))
```

\begin{landscape}

```{r hr-vax-BNT162b2-sex, include=TRUE, fig.cap="Adjusted hazard ratios for BNT162b2 vs unvaccinated in males and females separately.", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_BNT162b2_sex.png"))
```

```{r hr-vax-ChAdOx1-sex, include=TRUE, fig.cap="Adjusted hazard ratios for ChAdOx1 vs unvaccinated in males and females separately.", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_ChAdOx1_sex.png"))
```

\end{landscape}

```{r hr-vax-anytest-BNT162b2-sex, include=TRUE, fig.cap="Adjusted hazard ratios for any SARS-CoV-2 test for BNT162b2 vs unvaccinated in males and females separately.", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_anytest_BNT162b2_sex.png"))
```

```{r hr-vax-anytest-ChAdOx-sex, include=TRUE, fig.cap="Adjusted hazard ratios for any SARS-CoV-2 test for ChAdOx1 vs unvaccinated in males and females separately.", out.width="\\linewidth"}
knitr::include_graphics(file.path(release_folder, "hr_vax_anytest_ChAdOx1_sex.png"))
```

