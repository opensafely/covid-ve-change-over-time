---
output: 
  bookdown::pdf_document2:
    includes:
      in_header: preamble.tex
      before_body: preface.tex
    keep_tex: true
    latex_engine: xelatex
    toc: false # defined in preface.tex
fontsize: 10
subparagraph: yes
geometry: margin=2cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  include = FALSE,
  fig.pos = "H"
)
```

```{r libraries}
library(tidyverse)
library(flextable)
library(ftExtra)
library(officer)
library(glue)
```

```{r paths}
# path for images
image_path <- here::here("manuscript", "images")
# path for released results
release_folder <- "release20220226"
```

```{r read-meta-data}
# read study parameters
study_parameters <- readr::read_rds(
  here::here("output", "lib", "study_parameters.rds"))

# read varlist
 model_varlist <- readr::read_rds(
    here::here("output", "lib", "model_varlist.rds"))

# read subgroups
subgroups <- readr::read_rds(
  here::here("output", "lib", "subgroups.rds"))
subgroup_labels <- seq_along(subgroups)
subgroup_order <- c(4,1,3,2)
subgroups_long <- if_else(
    subgroups %in% subgroups[c(2,3)],
    as.character(glue("{subgroups} and not clinically vulnerable")),
    subgroups
  )

# outcomes 
outcomes <- readr::read_rds(
  here::here("output", "lib", "outcomes.rds"))
outcomes_order <- c(which(outcomes == "covidadmitted"),
                    which(outcomes == "coviddeath"),
                    which(outcomes == "postest"),
                    which(outcomes == "noncoviddeath"),
                    which(outcomes == "anytest"))
select_outcomes <- unname(outcomes[outcomes_order])

# scale for k
K <- study_parameters$max_comparisons
ends <- seq(2, (K+1)*4, 4)
starts <- ends + 1
weeks_since_2nd_vax <- str_c(starts[-(K+1)], ends[-1], sep = "-")
```


```{r read-data}
# read event counts data
event_counts <- readr::read_csv(
  here::here(release_folder, "event_counts_BNT162b2.csv")) %>%
  bind_rows(
    readr::read_csv(
  here::here(release_folder, "event_counts_ChAdOx.csv")) %>%
    filter(arm != "unvax") # because unvax arm same in both datasets
  ) %>%
  mutate(across(arm,
                factor,
                levels = c("BNT162b2", "ChAdOx", "unvax"),
                labels = c("BNT162b2", "ChAdOx", "Unvaccinated"))) %>%
  mutate(across(outcome,
                factor,
                levels = unname(outcomes[outcomes_order]),
                labels = names(outcomes[outcomes_order])))

# read estimates data
estimates_all <- readr::read_csv(
  here::here(release_folder, "estimates_all.csv")) %>%
  mutate(across(model, ~as.integer(str_remove(.x, "unadjusted")))) %>%
  mutate(across(c(estimate, conf.low, conf.high), 
                ~format(round(.x, digits=2), nsmall=2, trim = TRUE))) %>%
  mutate(across(outcome,
                factor,
                levels = unname(outcomes[outcomes_order]),
                labels = names(outcomes[outcomes_order]))) %>%
      mutate(across(comparison,
                  factor,
                  levels = c("BNT162b2", "ChAdOx", "both"),
                  labels = c("BNT162b2 vs unvaccinated", "ChAdOx vs unvaccinated", "BNT162b2 vs ChAdOx"))) 

# read metaregression results
metareg_results_k <- readr::read_rds(
  here::here(release_folder, "metareg_results_k.rds")) %>%
  mutate(across(subgroup, as.integer)) %>%
  mutate(across(outcome,
                factor,
                levels = unname(outcomes[outcomes_order]),
                labels = names(outcomes[outcomes_order]))) %>%
      mutate(across(comparison,
                  factor,
                  levels = c("BNT162b2", "ChAdOx", "both"),
                  labels = c("BNT162b2 vs unvaccinated", "ChAdOx vs unvaccinated", "BNT162b2 vs ChAdOx"))) %>%
   mutate(across(c(logrhr, logrhr_lower, logrhr_higher), 
                ~format(round(exp(.x), digits=2), nsmall=2, trim = TRUE))) %>%
  select(subgroup, comparison, outcome, k, rhr = logrhr, rhr_lower = logrhr_lower, rhr_higher = logrhr_higher)
```

```{r flextable-defaults}
set_flextable_defaults(
  font.family = "Times New Roman",
  font.size = 8,
  font.color = "black",
  table.layout = "fixed",
  digits = 1#,
  # theme_fun = "theme_vanilla"
  )
```

# Supplementary Methods

# Supplementary Results
Test some text referring to \figref{fig:svp-10-2021-04-13} and \tabref{tab:table1}.

```{r prep-table1}
table1_ft <- local({
  
  # create table1_ft
  table1 <- bind_rows(
    lapply(
      1:4,
      function(x) 
        readr::read_csv(here::here(release_folder, glue("table1_{x}_REDACTED.csv")),
                        show_col_types = FALSE) %>%
        mutate(subgroup = x)
    ) 
  ) %>%
    pivot_wider(
      names_from = subgroup,
      values_from = c(BNT162b2, ChAdOx, Unvaccinated),
      names_glue = "{subgroup}_{.value}"
    ) %>%
    select(-`2_ChAdOx`) %>%
    select(Variable, Characteristic, starts_with(as.character(subgroup_order))) %>%
    mutate(across(starts_with(as.character(subgroup_order)),
                  ~ if_else(
                    is.na(.x),
                    "-",
                    .x)))
  
  # column names for table
  table1_names <- names(table1)
  col_names <- str_remove(table1_names, "\\d_")
  names(col_names) <- table1_names
  cols_subtype <- sapply(
    as.character(subgroup_labels), 
    function(x) sum(str_detect(table1_names, glue("{x}_")))
  )
  
  variable_order <- c(NA_character_, "Age", "Sex", "IMD", "Ethnicity", "BMI", "Morbidity count", "Number of SARS-CoV-2 tests between 2020-05-18 and 2020-12-08", "Flu vaccine in previous 5 years", "Shielding criteria met")
  
  table1_manuscript <- tibble(Variable = variable_order) %>%
    left_join(table1) %>%
    mutate(across(Variable, ~str_remove(.x, " between 2020-05-18 and 2020-12-08"))) %>%
    mutate(across(Variable, ~str_remove(.x, " criteria met"))) 
  readr::write_rds(
    table1_manuscript,
    here::here(release_folder, "table1_manuscript.rds"))
  
  variable_order_supplement <- c(NA_character_, "Region", "JCVI group", "Resident in long-term residential home",
                                 "History of", "Pregnancy", "Housebound")
  
  table_ft <- tibble(Variable = variable_order_supplement) %>%
    left_join(table1, by = "Variable") %>%
    mutate(tmp = row_number()) %>%
    group_by(Variable) %>%
    mutate(tmp = mean(tmp)) %>%
    arrange(Characteristic,.by_group = TRUE) %>%
    ungroup() %>%
    arrange(tmp) %>%
    select(-tmp) %>%
    mutate(across(Characteristic, 
                  ~if_else(.x == "Immunosuppression",
                           "Immunosupp- ression",
                           .x))) %>%
    as_grouped_data(groups = "Variable") %>%
    as_flextable(hide_grouplabel = TRUE) %>%
    bold(
      i = ~ !is.na(Variable),
      j = 1,
      part = "body"
    ) %>%
    set_header_labels(
      values = as.list(col_names)
    ) %>%
    add_header_row(
      values = c("", subgroups[subgroup_order]),
      colwidths = c(1, cols_subtype[subgroup_order])
    ) %>%
    bold(
      part = "header"
    )
  
  return(table_ft)
  
})
```

```{r prep-table-events}
table_events_ft <- local({
  
  prep_table <- event_counts %>%
    arrange(subgroup, outcome, arm, k) %>%
    mutate(across(c(events, person_years), ~scales::comma(.x, accuracy = 1))) %>%
    mutate(name = as.character(glue("{subgroup}_{arm}"))) %>%
    mutate(value = as.character(glue("{events} / {person_years}"))) %>%
    mutate(across(value, ~str_replace(.x, "NA", "-"))) %>%
    select(name, value, k, outcome) %>%
    pivot_wider(
      names_from =  name,
      values_from = value
    ) %>%
    mutate(across(k,
                  factor,
                  levels = 1:K,
                  labels = weeks_since_2nd_vax)) %>%
    select(outcome, k, starts_with(as.character(subgroup_order)))
  
  # column names for table
  table_names <- names(prep_table)
  col_names <- str_remove(table_names, "\\d_")
  names(col_names) <- table_names
  cols_subtype <- sapply(
    as.character(subgroup_labels), 
    function(x) sum(str_detect(table_names, glue("{x}_")))
  )
  col_names["k"] <- "Weeks since 2nd dose"
  
  
  prep_table %>%
    as_grouped_data(groups = "outcome") %>%
    as_flextable(hide_grouplabel = TRUE) %>%
    bold(
      i = ~ !is.na(outcome),
      j = 1,
      part = "body"
    ) %>%
    set_header_labels(
      values = as.list(col_names)
    ) %>%
    add_header_row(
      values = c("", subgroups[subgroup_order]),
      colwidths = c(1, cols_subtype[subgroup_order])
    ) %>%
    bold(
      part = "header"
    ) %>%
    width(j = 1, width = 1, unit = "cm") %>%
    width(j = 2:12, width = 21.5/11, unit = "cm") 
  
})
```

```{r prep-table-hrs}
table_hrs_ft <- local({
  
  prep_table <- estimates_all %>%
    filter(
      variable == "k",
      model == 2,
      !reference_row
      ) %>%
    mutate(
      name = glue("{subgroup}_{comparison}"),
      value = glue("{estimate} ({conf.low}-{conf.high})")
    ) %>%
    mutate(across(c(name, value), as.character)) %>%
    mutate(k = factor(as.integer(label),
                      levels = 1:K,
                      labels = weeks_since_2nd_vax)) %>%
    arrange(subgroup, comparison, outcome, k) %>%
    select(name, outcome, k, value) %>%
    pivot_wider(
      names_from = name,
      values_from = value
    ) %>%
    select(outcome, k, starts_with(as.character(subgroup_order))) %>%
     mutate(across(starts_with(as.character(subgroup_order)),
                  ~ if_else(
                    str_detect(.x, "NA"),
                    NA_character_,
                    .x)
                  )) 
  
    drop_cols <- sapply(
    seq_along(prep_table),
    function(x) all(is.na(prep_table[[x]]))
  )
  
  # column names for table
  table_names <- names(prep_table)
  col_names <- str_remove(table_names, "\\d_")
  names(col_names) <- table_names
  cols_subtype <- sapply(
    as.character(subgroup_labels), 
    function(x) sum(str_detect(table_names, glue("{x}_")))
  )
  col_names["k"] <- "Weeks since 2nd dose"
  
  prep_table %>%
    select(all_of(table_names)) %>%
    mutate(across(starts_with(as.character(subgroup_order)),
                  ~ if_else(
                    is.na(.x),
                    "-",
                    .x)
                  ))  %>%
    as_grouped_data(groups = "outcome") %>%
    as_flextable(hide_grouplabel = TRUE) %>%
    bold(
      i = ~ !is.na(outcome),
      j = 1,
      part = "body"
    ) %>%
    set_header_labels(
      values = as.list(col_names)
    ) %>%
    add_header_row(
      values = c("", subgroups[subgroup_order]),
      colwidths = c(1, cols_subtype[subgroup_order])
    ) %>%
    bold(
      part = "header"
    ) %>%
    width(j = 1, width = 1, unit = "cm") %>%
    width(j = 2:11, width = 21.5/10, unit = "cm") 
  
  
})
```

```{r prep-table-metareg}
table_metareg_ft <- local({
  
  prep_table <- metareg_results_k %>%
  mutate(
      name = glue("{subgroup}_{comparison}"),
      value = glue("{rhr} ({rhr_lower}-{rhr_higher})")
    ) %>%
    mutate(across(c(name, value), as.character)) %>%
    arrange(subgroup, comparison, outcome) %>%
    distinct(name, outcome, value) %>%
    pivot_wider(
      names_from = name,
      values_from = value
    ) %>%
    select(outcome, starts_with(as.character(subgroup_order))) %>%
    mutate(across(starts_with(as.character(subgroup_order)),
                  ~ if_else(
                    str_detect(.x, "NA"),
                    NA_character_,
                    .x)
                  )) 
  
  drop_cols <- sapply(
    seq_along(prep_table),
    function(x) all(is.na(prep_table[[x]]))
  )
  
  # column names for table
  table_names <- names(prep_table)[!drop_cols]
  col_names <- str_remove(table_names, "\\d_")
  names(col_names) <- table_names
  cols_subtype <- sapply(
    as.character(subgroup_labels), 
    function(x) sum(str_detect(table_names, glue("{x}_")))
  )
  
  prep_table %>%
    select(all_of(table_names)) %>%
    mutate(across(starts_with(as.character(subgroup_order)),
                  ~ if_else(
                    is.na(.x),
                    "-",
                    .x)
                  ))  %>%
    as_grouped_data(groups = "outcome") %>%
    as_flextable(hide_grouplabel = TRUE) %>%
    bold(
      i = ~ !is.na(outcome),
      j = 1,
      part = "body"
    ) %>%
    set_header_labels(
      values = as.list(col_names)
    ) %>%
    add_header_row(
      values = subgroups[subgroup_order],
      colwidths = cols_subtype[subgroup_order]
    ) %>%
    bold(
      part = "header"
    ) %>%
    width(j = 1:10, width = 22/10, unit = "cm") 
  
})
```

```{r prep-table-estimates-covs-ft}
# create estimates_covs
estimates_covs <- estimates_all %>%
  filter(variable != "k") %>%
  mutate(across(subgroup, 
                factor, 
                levels = subgroup_order, 
                labels = subgroups[subgroup_order])) %>%
  group_split(subgroup) %>%
  as.list()

table_estimates_covs_ft <- function(i) {
  
  subgroup <- unique(estimates_covs[[i]]$subgroup)
  subgroup_long <- subgroups_long[subgroups == subgroup]
  
  
  table <- estimates_covs[[i]] %>%
    transmute(
      comparison = comparison,
      outcome = outcome,
      variable = variable,
      label = label,
      value = if_else(
        !reference_row | is.na(reference_row),
        as.character(glue("{estimate} ({conf.low}-{conf.high})")),
        "1.00 (ref)"
      )
    ) %>%
    pivot_wider(
      names_from = outcome,
      values_from = value
    ) %>%
    select(comparison, variable, label, all_of(names(outcomes[outcomes_order]))) 
  
  age_order <- sort(unique(table$label[str_detect(table$label, "^age")]))
  age_order <- age_order[age_order!="age"]
  
  history_of_vars <- c(
    "chronic_respiratory_disease",
    "chronic_heart_disease", 
    "chronic_liver_disease", 
    "ckd", 
    "chronic_neuro_inc_ld",
    "diabetes",
    "any_immunosuppression", 
    "ld_inc_ds_and_cp", 
    "sev_ment")
  
  tibble(
    Variable = c(age_order, names(c(model_varlist$demographic, model_varlist$clinical))),
    variable = c(age_order, unname(unlist(model_varlist)))
  ) %>%
    full_join(table, by = "variable") %>%
    filter(Variable != "Age") %>% # remove this line after new results released
    select(-variable) %>%
    mutate(across(Variable, ~if_else(str_detect(label, "^age"), "Age", .x))) %>%
    mutate(label_old = label) %>%
    mutate(across(label, 
                  ~if_else(.x %in% glue("{history_of_vars}TRUE"),
                           Variable,
                           .x))) %>%
    mutate(across(Variable, 
                  ~if_else(label_old %in% glue("{history_of_vars}TRUE"),
                           "History of",
                           .x))) %>%
    mutate(across(label, 
                  ~if_else(str_detect(.x, "TRUE$"),
                           "yes",
                           .x))) %>%
    mutate(across(Variable, 
                  ~if_else(str_detect(.x, "Number of SARS-CoV-2 tests"),
                           "Number of SARS-CoV-2 tests",
                           .x))) %>%
    mutate(across(all_of(names(outcomes)), ~if_else(is.na(.x), "-", .x))) %>%
    select(-label_old) %>%
    select(comparison, Variable, Category = label, all_of(names(outcomes[outcomes_order]))) %>%
    arrange(comparison) %>%
    as_grouped_data(groups = "comparison") %>%
    as_flextable(hide_grouplabel = TRUE) %>% 
    merge_v(j = "Variable") %>% 
    valign(valign = "top") %>% 
    width(j = 1:7, width = 22/7, unit = "cm") %>%
    bold(part="header") %>%
     bold(
    i = ~ !is.na(comparison),
    j = 1,
    part = "body"
  ) %>%
    footnote(
      i = 1, j = 2,
      value = as_paragraph("Categories separated by \" / \" were merged due to low event counts."),
      ref_symbols = "a",
      part = "header",
      inline = FALSE
      ) %>%
    footnote(
      i = 1, j = 1,
      value = as_paragraph("Age terms were fit separately within strata. The age range in the strata is indicated by the suffix following the underscore on the age category label. Strata in which the age range was < 5 years included only a linear age term, otherwise a quadratic age term was included."),
      ref_symbols = "b",
      part = "body",
      inline = FALSE
      ) 
}
```

\begin{landscape}

```{r svp-10-2021-04-13, include=TRUE, fig.cap="Second vaccination period", fig.width=20}
knitr::include_graphics(file.path(image_path, "plot_by_region_10_2021-04-13.png"))
```


```{r table1, include=TRUE, tab.cap.pre = "Supplementary Table ", tab.cap="Additional characteristics summarised across groups."}
table1_ft
```

```{r table-events, include=TRUE, tab.cap.pre = "Supplementary Table ", tab.cap="Event counts during each comparison period."}
table_events_ft
```

```{r table-hrs-ft, include=TRUE, tab.cap.pre = "Supplementary Table ", tab.cap="Adjusted hazard ratios for each comparison period."}
table_hrs_ft
```

```{r table-ratio-hrs-ft, include=TRUE, tab.cap.pre = "Supplementary Table ", tab.cap="Ratio of adjusted hazard ratios for each comparison period."}
table_metareg_ft
```


```{r table-estimates-covs-ft-1, include=TRUE, tab.cap.pre = "Supplementary Table "}
table_estimates_covs_ft(1)
```

\end{landscape}
