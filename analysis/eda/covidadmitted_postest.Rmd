---
title: "Investigating the distribution of positive tests around COVID-19 hospitalisations"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r libraries}
library(tidyverse)
library(lubridate)
library(kableExtra)
library(glue)
```

```{r}
source(here::here("analysis", "functions", "data_process_functions.R"))
```

Our plan is to replace the outcome variable `covidadmitted`, which currently corresponds to the date of a COVID-19 hospitalisation.
The new variable will correspond to "an episode of COVID-19 resulting in hospitalisation", and will take the date of the first positive test during the episode of COVID-19.
We have carried out some exploratory data analysis to inform the algorithm that we will use to derive this new variable.

First, Table 1 shows the number of eligible patients who have a COVID-19 hospitalisation in their record.
For the patients with a COVID-19 hospitalisation, we counted the number of positive tests in their record during the window 6 weeks before and 2 weeks after the date of their COVID-19 hospitalisation. 
To speed up computation, the number of positive tests was capped at 6.
These results are given in Table 2.

We used histograms to investigate the distribution of positive test date relative to COVID-19 hospitalisation date.
Figure 1 shows the distribution of positive test dates for all tests during the window, and Figure 2 shows the distribution of each patients earliest positive test date during the window.
The y-axes start at 6 to mask bars that correspond to <=5 patients.

```{r}
# read data for ever covariates
data_ever <- arrow::read_feather(
  file = here::here("output", "input_ever.feather")) 

# clean data
data_0 <- data_ever %>%
  select(patient_id, covidadmitted_post_date, covidadmittedprimary_post_date, starts_with("covidadmitted_postest")) %>%
  mutate(across(contains("_date"), 
                ~ floor_date(
                  as.Date(.x, format="%Y-%m-%d"),
                  unit = "days"))) #%>%
  # # only keep postests in the window
  # mutate(across(starts_with("covidadmitted_postest"),
  #               ~ if_else(
  #                 is.na(covidadmitted_post_date) | 
  #                   as.integer(.x - covidadmitted_post_date) < -42 |
  #                   as.integer(.x - covidadmitted_post_date) > 14,
  #                 as.Date(NA_character_), 
  #                 .x
  #               )))
```

#### Table 1. Patients with a COVID-19 hospital admission by recording field
```{r}
data_0 %>%
  mutate(across(c(covidadmitted_post_date, covidadmittedprimary_post_date),
         ~!is.na(.x))) %>%
  group_by(covidadmitted_post_date, covidadmittedprimary_post_date) %>%
  count() %>%
  ungroup() %>%
  mutate(percent = round(100*n/sum(n), 2)) %>%
  mutate(across(n, scales::comma, accuracy=1)) %>%
  kbl(
    col.names = c("any field", "primary field", "n", "percent")
  ) %>%
  kable_styling(full_width = F)
```

#### Hospitalistion with COVID in primary and any field on same date
```{r}
data_0 %>%
  filter(
    !is.na(covidadmitted_post_date),
    !is.na(covidadmittedprimary_post_date)
    ) %>%
  mutate(
    same_date = covidadmitted_post_date == covidadmittedprimary_post_date
    ) %>%
  group_by(same_date) %>%
  count() %>%
  ungroup() %>%
  mutate(percent = round(100*n/sum(n), 2)) %>%
  mutate(across(n, scales::comma, accuracy=1)) %>%
  kbl(
    col.names = c("Same date", "n", "percent")
  ) %>%
  kable_styling(full_width = F)
```


```{r}
data_1 <- data_0 %>%
  filter(!is.na(covidadmitted_post_date)) %>%
  pivot_longer(
    cols = c(covidadmitted_post_date, covidadmittedprimary_post_date),
    values_drop_na = TRUE
  ) %>%
  mutate(
    covidadmitted_field = if_else(
      name %in% "covidadmittedprimary_post_date",
      "primary",
      "any")
    ) %>%
  select(-name) %>%
  rename(covidadmitted_date = value) %>%
  pivot_longer(
    cols = starts_with("covidadmitted_postest"),
    names_pattern = "covidadmitted_postest_(.)_date",
    names_transform = as.integer,
    values_drop_na = TRUE
  ) %>%
  select(-name) %>%
  mutate(diff = as.numeric(value - covidadmitted_date)) %>%
  filter(-42 <= diff, diff <= 14) %>%
  group_by(patient_id, covidadmitted_field) %>%
  arrange(value, .by_group = TRUE) %>%
  mutate(
    sequence = row_number(),
    min_postest_date = min(sequence),
    max_postest_date = max(sequence)
    ) %>%
  ungroup()
```

#### Table 2. Number of positive tests per patient during the window around hospitalisation date
```{r}
n_tests <- local({
  counts <- data_1 %>% 
    distinct(patient_id, covidadmitted_field, max_postest_date) %>%
    group_by(max_postest_date, covidadmitted_field) %>%
    count() %>%
    ungroup() %>%
    mutate(across(c(max_postest_date, n), as.integer))
  
  total_any <- sum(counts[counts$covidadmitted_field == "any",]$n)
  total_primary <- sum(counts[counts$covidadmitted_field == "primary",]$n)
  
  counts %>%
    pivot_wider(
      names_from = covidadmitted_field,
      values_from = n
    ) %>%
    rename(n_postests = max_postest_date) %>%
    add_row(
      n_postests = 0L, 
      any = nrow(data_0 %>% filter(!is.na(covidadmitted_post_date))) - total_any,
      primary = nrow(data_0 %>% filter(!is.na(covidadmittedprimary_post_date))) - total_primary
    ) %>%
    arrange(n_postests) %>%
    mutate(across(c(any, primary), 
                  ~if_else(is.na(.x),0L,.x))) %>%
    mutate(across(c(any, primary), 
                  ~str_c(scales::comma(.x, accuracy = 1), " (", round(100*.x/sum(.x), 2), ")")))
  
})

n_tests %>%
  kbl() %>%
  kable_styling(full_width = F) %>%
  add_header_above(c(" " = 1, "field" = 2))
```


```{r}
my_hist <- function(data, filename) {
  
  plot <- data %>%
    mutate(across(covidadmitted_field,
                  ~str_c("field = ", .x))) %>%
  ggplot(aes(x = diff, fill = covidadmitted_field)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
    stat_count(
      alpha = 0.8
    ) +
    facet_wrap(~covidadmitted_field, ncol=1, scales = "free_y") +
  scale_x_continuous(
    breaks = seq(-42,14,7),
    limits = c(-42,14),
    labels = as.character(seq(-6,2,1))
  ) +
  labs(
    x = "Weeks since COVID-19 hospital admission",
    y = "Number of positive tests"
  ) +
  theme_bw() +
  theme(
    axis.title.x = element_text(margin = margin(t=10)),
    axis.title.y = element_text(margin = margin(r=10)),
    legend.position = "none"
  ) +
    coord_cartesian(ylim = c(6,NA))
  
# ggsave(
#   plot = plot,
#   filename = here::here("output", "eda", glue("{filename}.png"))
# )

return(plot)
  
}
```


#### Figure 1. Distribution of all positive test dates within window relative to date of hospitalisation
```{r}
# distribution of all positive test dates relative to date of hospital admission
data_1 %>%
  my_hist(filename = "covidadmitted_postest_all")
```

#### Figure 2. Distribution of earliest positive test dates within window relative to date of hospitalisation
```{r}
# distribution of all positive test dates relative to date of hospital admission
data_1 %>%
  filter(sequence == min_postest_date) %>%
  my_hist(filename = "covidadmitted_postest_min")
```

#### Table 2. Number of patients with a positive test 6-4 weeks before hospitalisation and during the window 4 weeks before to 2 weeks after hospitalisation
```{r}
postest_after_4wks <- data_1 %>%
  filter(diff < -28) %>%
  select(patient_id, covidadmitted_field) %>%
  left_join(data_1, by = c("patient_id", "covidadmitted_field")) %>%
  mutate(postest_after_4wks = diff > -28)

postest_after_4wks %>%
  distinct(patient_id, covidadmitted_field, postest_after_4wks) %>%
  group_by(covidadmitted_field, postest_after_4wks) %>%
  count() %>%
  ungroup() %>%
  pivot_wider(
    names_from = covidadmitted_field,
    values_from = n
  ) %>%
  mutate(across(c(any, primary), ~if_else(is.na(.x), 0L, .x))) %>%
  mutate(across(c(any, primary), 
                  ~str_c(scales::comma(.x, accuracy = 1), " (", round(100*.x/sum(.x), 2), ")"))) %>%
  kbl() %>%
  kable_styling(full_width = F) %>%
  add_header_above(c(" " = 1, "field" = 2))
```


#### Figure 3. Distribution of all positive test dates within window relative to date of hospital admission for those who have a positive test 6-4 weeks before the date of hospitalisation 
```{r}
# distribution of all positive test dates relative to date of hospital admission
postest_after_4wks %>%
  filter(diff > -28) %>%
  my_hist(filename = "covidadmitted_postest_min")
```

